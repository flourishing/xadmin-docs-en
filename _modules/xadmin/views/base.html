<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>xadmin.views.base &mdash; Django Xadmin 2.1.5 beta documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.1.5 beta',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Django Xadmin 2.1.5 beta documentation" href="../../../index.html" />
    <link rel="up" title="xadmin.views" href="../views.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Django Xadmin 2.1.5 beta documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../views.html" accesskey="U">xadmin.views</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for xadmin.views.base</h1><div class="highlight"><pre>
<span class="c"># coding=utf-8</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">update_wrapper</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getargspec</span>

<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">force_unicode</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.core.serializers.json</span> <span class="kn">import</span> <span class="n">DjangoJSONEncoder</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">django.template.response</span> <span class="kn">import</span> <span class="n">TemplateResponse</span>
<span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">SortedDict</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span><span class="p">,</span> <span class="n">classonlymethod</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">smart_unicode</span>
<span class="kn">from</span> <span class="nn">django.utils.http</span> <span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span> <span class="nn">django.utils.itercompat</span> <span class="kn">import</span> <span class="n">is_iterable</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">django.utils.text</span> <span class="kn">import</span> <span class="n">capfirst</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_protect</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">xadmin.util</span> <span class="kn">import</span> <span class="n">static</span><span class="p">,</span> <span class="n">json</span><span class="p">,</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">sortkeypicker</span>

<span class="c">#: 通用的csrf_protect_m装饰器，给其他模块的 AdminView 使用</span>
<span class="n">csrf_protect_m</span> <span class="o">=</span> <span class="n">method_decorator</span><span class="p">(</span><span class="n">csrf_protect</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IncorrectPluginArg</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; 当插件的方法参数错误时抛出该异常 &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">filter_chain</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">_inner_method</span><span class="p">():</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="n">filters</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="n">fargs</span> <span class="o">=</span> <span class="n">getargspec</span><span class="p">(</span><span class="n">fm</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># 只有 self 一个参数，这时如果 AdminView 方法的执行结果是 None 则没有问题，否则会抛出异常</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fm</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">IncorrectPluginArg</span><span class="p">(</span><span class="s">u&#39;Plugin filter method need a arg to receive parent method result.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># 如果第一个参数为 ``__`` ，传入的参数为 func， 而非 func()</span>
                <span class="k">return</span> <span class="n">fm</span><span class="p">(</span><span class="n">func</span> <span class="k">if</span> <span class="n">fargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;__&#39;</span> <span class="k">else</span> <span class="n">func</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filter_chain</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">token</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_inner_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="filter_hook"><a class="viewcode-back" href="../../../make_plugin.html#xadmin.views.base.filter_hook">[docs]</a><span class="k">def</span> <span class="nf">filter_hook</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    表明 AdminView 的方法可以被插件插入的装饰器。执行使用了该装饰器的方法时，会按照以下过程执行:</span>

<span class="sd">        1. 首先将实例的 plugins 属性取出，取出含有同样方法名的插件</span>

<span class="sd">        2. 按照插件方法的 ``priority`` 属性排序</span>

<span class="sd">        3. 顺序执行插件方法，执行插件方法的规则:</span>

<span class="sd">            * 如果插件方法没有参数，AdminView 方法的返回结果不为空则抛出异常</span>

<span class="sd">            * 如果插件方法的第一个参数为 ``__`` ，则 AdminView 方法将作为第一个参数传入，注意，这时还未执行该方法，</span>
<span class="sd">              在插件中可以通过 ``__()`` 执行，这样就可以实现插件在 AdminView 方法执行前实现一些自己的逻辑，例如::</span>

<span class="sd">                def get_context(self, __):</span>
<span class="sd">                    c = {&#39;key&#39;: &#39;value&#39;}</span>
<span class="sd">                    c.update(__())</span>
<span class="sd">                    return c</span>

<span class="sd">            * 如果插件方法的第一个参数不为 ``__`` ，则执行 AdminView 方法，将结果作为第一个参数传入</span>

<span class="sd">        4. 最终将插件顺序执行的结果返回</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="s">&quot;``filter_hook``</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="ow">or</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c"># 将 AdminView 的方法先封装起来，方便后面执行</span>
        <span class="k">def</span> <span class="nf">_inner_method</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="c"># 首先取出所有含有同名方法的插件</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tag</span><span class="p">),</span> <span class="s">&#39;priority&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">None</span><span class="p">))]</span>
            <span class="c"># 按照 ``priority`` 属性排序</span>
            <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">return</span> <span class="n">filter_chain</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_inner_method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_inner_method</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">method</span>

</div>
<span class="k">def</span> <span class="nf">inclusion_tag</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">context_class</span><span class="o">=</span><span class="n">Context</span><span class="p">,</span> <span class="n">takes_context</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    为 AdminView 的 block views 提供的便利方法，作用等同于 :meth:`django.template.Library.inclusion_tag`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">_dict</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">get_template</span><span class="p">,</span> <span class="n">select_template</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">Template</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">file_name</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_iterable</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">select_template</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">new_context</span> <span class="o">=</span> <span class="n">context_class</span><span class="p">(</span><span class="n">_dict</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
                <span class="s">&#39;autoescape&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">autoescape</span><span class="p">,</span>
                <span class="s">&#39;current_app&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">current_app</span><span class="p">,</span>
                <span class="s">&#39;use_l10n&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">use_l10n</span><span class="p">,</span>
                <span class="s">&#39;use_tz&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">use_tz</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="c"># 添加 admin_view</span>
            <span class="n">new_context</span><span class="p">[</span><span class="s">&#39;admin_view&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s">&#39;admin_view&#39;</span><span class="p">]</span>
            <span class="n">csrf_token</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">csrf_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">new_context</span><span class="p">[</span><span class="s">&#39;csrf_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csrf_token</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">new_context</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">method</span>
    <span class="k">return</span> <span class="n">wrap</span>


<span class="k">class</span> <span class="nc">JSONEncoder</span><span class="p">(</span><span class="n">DjangoJSONEncoder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">JSONEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">smart_unicode</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseAdminObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    提供给 :class:`BaseAdminView` 和 :class:`BaseAdminPlugin` 的通用基类，主要是提供了一些常用的通用方法</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_class</span><span class="p">,</span> <span class="n">option_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取 AdminViewClass 的实例。实际上就是调用 :meth:`~xadmin.sites.AdminSite.get_view_class` 方法</span>

<span class="sd">        :param view_class: AdminViewClass 的类</span>
<span class="sd">        :param option_class: 希望与 AdminViewClass 合并的 OptionClass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;opts&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">get_view_class</span><span class="p">(</span><span class="n">view_class</span><span class="p">,</span> <span class="n">option_class</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_class</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取 ModelAdminViewClass 的实例。首先通过 :class:`~xadmin.sites.AdminSite` 取得 model 对应的 OptionClass，然后调用 :meth:`get_view` 方法</span>

<span class="sd">        :param view_class: ModelAdminViewClass 的类</span>
<span class="sd">        :param model: 绑定的 Model 类</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_view</span><span class="p">(</span><span class="n">view_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_admin_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        便捷方法，方便的通过 name 取得 url，会加上 AdminSite.app_name 的 url namespace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        便捷方法，方便的通过 model, name 取得 url，会自动拼成 urlname，并会加上 AdminSite.app_name 的 url namespace</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                             <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">current_app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        获取 Model 的某种权限标签，标签的格式为::</span>

<span class="sd">            &gt;&gt;&gt; view.get_model_perm(User, &#39;view&#39;)</span>
<span class="sd">            &gt;&gt;&gt; &#39;auth.user_view&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">module_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_model_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        判断当前用户是否有某个 Model 的 某种权限，例如:</span>

<span class="sd">            &gt;&gt;&gt; view.has_model_perm(User, &#39;view&#39;)</span>
<span class="sd">            &gt;&gt;&gt; True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_model_perm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;view&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_model_perm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_query_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        在当前的query_string基础上生成新的query_string</span>

<span class="sd">        :param new_params: 要新加的参数，该参数为 dict </span>
<span class="sd">        :param remove: 要删除的参数，该参数为 list, tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">remove</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="s">&#39;?</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_form_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        将当前 request 的参数，新加或是删除后，生成 hidden input。用于放入 HTML 的 Form 中。</span>

<span class="sd">        :param new_params: 要新加的参数，该参数为 dict </span>
<span class="sd">        :param remove: 要删除的参数，该参数为 list, tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">remove</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">new_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s">&#39;&lt;input type=&quot;hidden&quot; name=&quot;</span><span class="si">%s</span><span class="s">&quot; value=&quot;</span><span class="si">%s</span><span class="s">&quot;/&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">response_type</span><span class="o">=</span><span class="s">&#39;json&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        便捷方法，方便生成 HttpResponse，如果 response_type 为 ``json`` 会自动转为 json 格式后输出</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">response_type</span> <span class="o">==</span> <span class="s">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">mimetype</span><span class="o">=</span><span class="s">&quot;application/json; charset=UTF-8&quot;</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">JSONEncoder</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">template_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        便捷方法，方便生成 TemplateResponse</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">TemplateResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">current_app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">message_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s">&#39;info&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a message to the user. The default implementation</span>
<span class="sd">        posts a message using the django.contrib.messages backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">level</span><span class="p">)):</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">level</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">static</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :meth:`xadmin.util.static` 的快捷方法，返回静态文件的 url。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">static</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">vendor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tags</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">vendor</span><span class="p">(</span><span class="o">*</span><span class="n">tags</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseAdminPlugin</span><span class="p">(</span><span class="n">BaseAdminObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    所有 Plugin 的基类。继承于 :class:`BaseAdminObject` 。插件的注册和使用可以参看 :meth:`xadmin.sites.AdminSite.register_plugin` ，</span>
<span class="sd">    插件的原理可以参看 :func:`filter_hook` :</span>

<span class="sd">    .. autofunction:: xadmin.views.base.filter_hook</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">admin_view</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admin_view</span> <span class="o">=</span> <span class="n">admin_view</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span> <span class="o">=</span> <span class="n">admin_view</span><span class="o">.</span><span class="n">admin_site</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">admin_view</span><span class="p">,</span> <span class="s">&#39;model&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">admin_view</span><span class="o">.</span><span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">admin_view</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span>

    <span class="k">def</span> <span class="nf">init_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        插件的初始化方法，Plugin 实例化后被调用的第一个方法。该方法主要用于初始化插件需要的属性，</span>
<span class="sd">        同时判断当前请求是否需要加载该插件，例如 Ajax插件的实现方式::</span>

<span class="sd">            def init_request(self, *args, **kwargs):</span>
<span class="sd">                return bool(self.request.is_ajax() or self.request.REQUEST.get(&#39;_ajax&#39;))</span>

<span class="sd">        当返回值为 ``False`` 时，所属的 AdminView 实例不会加载该插件</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">BaseAdminView</span><span class="p">(</span><span class="n">BaseAdminObject</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    所有 AdminView 的基类。继承于 :class:`BaseAdminObject` 和 :class:`django.views.generic.View`</span>

<span class="sd">    该类是 xadmin 中 **最核心** 的类，所有的 AdminView 都需要继承此类。xadmin 与 Django Admin最大的区别就在于 xadmin </span>
<span class="sd">    每次请求会产生一个 AdminView 的实例，也就是基于 Class 的 view 方式。该方式在 Django 1.3 被实现，可以参看 Django 的官方文档</span>
<span class="sd">    `Class-based generic views &lt;https://docs.djangoproject.com/en/1.4/topics/class-based-views/&gt;`_</span>

<span class="sd">    使用 Class 的方式实现的好处显而易见。首先，每一次请求都会产生一个新的实例，这样 request 这种变量就可以保存在实例中，基类的扩展，或</span>
<span class="sd">    是复写父类方法时再也不用带着 request 到处跑了，当然，除了 request 还有很多可以基于实例存储的变量。</span>

<span class="sd">    其次，基于实例的方式非常方便的实现了插件功能，而且还能实现插件的动态加载，因为每个 AdminView 实例可以根据自身实例的属性情况来判断加载</span>
<span class="sd">    哪些插件，具体信息也可以参看 :class:`BaseAdminPlugin` 的描述。</span>

<span class="sd">    实现一个自己的 AdminView 类很简单，举例如下::</span>

<span class="sd">        from xadmin.sites import site</span>
<span class="sd">        from xadmin.views import BaseAdminView</span>

<span class="sd">        class MyAdminView(BaseAdminView):</span>

<span class="sd">            def get(self, request, *args, **kwargs):</span>
<span class="sd">                pass</span>

<span class="sd">        site.register_view(r&#39;^me_test/$&#39;, MyAdminView, name=&#39;my_test&#39;)</span>

<span class="sd">    而后您就可以在 ``me_test/`` 访问到该view了。当然xadmin同事提供了一些通用的 AdminView，分别为</span>

<span class="sd">        * :class:`CommAdminView` : xadmin通用界面的基础View，提供了xadmin通用界面需要的一些数据(菜单等)</span>
<span class="sd">        * :class:`ModelAdminView` : 核心类之一，提供了基于 Model 的 AdminView。</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">base_template</span> <span class="o">=</span> <span class="s">&#39;xadmin/base.html&#39;</span>
    <span class="n">need_site_permission</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">base_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                      <span class="s">&quot;plugin_classes&quot;</span><span class="p">,</span> <span class="p">[])]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_plugin</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classonlymethod</span>
    <span class="k">def</span> <span class="nf">as_view</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        复写了 :meth:`View.as_view` 方法，主要是将 :meth:`View.dispatch` 的也写到了本方法中，并且去掉了一些初始化操作，</span>
<span class="sd">        因为这些初始化操作在 AdminView 的初始化方法中已经完成了，可以参看 :meth:`BaseAdminView.init_request`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;get&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;head&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_names</span><span class="p">:</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_method_not_allowed</span>

            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">update_wrapper</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">updated</span><span class="o">=</span><span class="p">())</span>
        <span class="n">view</span><span class="o">.</span><span class="n">need_site_permission</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">need_site_permission</span>

        <span class="k">return</span> <span class="n">view</span>

    <span class="k">def</span> <span class="nf">init_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        一般用于子类复写的初始化方法，在 AdminView 实例化时调用，:class:`BaseAdminView` 的该方法不做任何操作。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">init_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        AdminView 实例中插件的初始化方法，在 :meth:`BaseAdminView.init_request` 后调用。根据 AdminView 中</span>
<span class="sd">        的 base_plugins 属性将插件逐一初始化，既调用 :meth:`BaseAdminPlugin.init_request` 方法，并根据返回结果判断是否加载该插件。</span>
<span class="sd">        最后该方法会将初始化后的插件设置为 plugins 属性。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_plugins</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
            <span class="n">p</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span>
            <span class="n">p</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span>
            <span class="n">p</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">init_request</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
                <span class="c"># 返回结果不为 `False` 就加载该插件</span>
                <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugins</span> <span class="o">=</span> <span class="n">plugins</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回显示页面所需的 context 对象。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;admin_view&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;media&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s">&#39;base_template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_template</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">media</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_media</span><span class="p">()</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_media</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        取得页面所需的 Media 对象，用于生成 css 和 js 文件</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">forms</span><span class="o">.</span><span class="n">Media</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CommAdminView</span><span class="p">(</span><span class="n">BaseAdminView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    基于 :class:`BaseAdminView` 提供的通用 AdminView。主要是完成了一些 xadmin 页面通用内容的处理。主要有:</span>

<span class="sd">        * 网站标题</span>
<span class="sd">        * 全局的 Model 图标</span>
<span class="sd">        * 网站菜单</span>
<span class="sd"> </span>
<span class="sd">    **View属性**:</span>
<span class="sd"> </span>
<span class="sd">        .. autoattribute:: site_title</span>
<span class="sd">        .. autoattribute:: site_footer</span>
<span class="sd">        .. autoattribute:: global_models_icon</span>
<span class="sd">        .. autoattribute:: base_template</span>
<span class="sd">        .. autoattribute:: default_model_icon</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">base_template</span> <span class="o">=</span> <span class="s">&#39;xadmin/base_site.html&#39;</span>    <span class="c">#: View模板继承的基础模板</span>
    <span class="n">menu_template</span> <span class="o">=</span> <span class="s">&#39;xadmin/includes/sitemenu_default.html&#39;</span>

    <span class="n">site_title</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c">#: 网站的标题</span>
    <span class="n">site_footer</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c">#: 网站的下角标文字</span>
    <span class="c">#: 全局的 Model 图标::</span>
    <span class="c">#:</span>
    <span class="c">#:     globe_models_icon = {User: &#39;user-icon&#39;}</span>
    <span class="n">global_models_icon</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">default_model_icon</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">apps_label_title</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">apps_icons</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_site_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;``FAQ:如何定制系统菜单``\n</span>
<span class="sd">        用于给子类复写的方法，开发者可以在子类或 OptionClass 中复写该方法，返回自己定义的网站菜单。菜单的格式为::</span>

<span class="sd">            ({</span>
<span class="sd">                &quot;title&quot;: &quot;菜单标题&quot;, &quot;perm&quot;: &quot;权限标示&quot;, </span>
<span class="sd">                &quot;icon&quot;: &quot;图标的 css class&quot;, &quot;url&quot;: &quot;菜单url&quot;, </span>
<span class="sd">                &quot;menus&quot;: [...]    # 子菜单项</span>
<span class="sd">            })</span>

<span class="sd">        菜单项的 ``perm`` 和 ``url`` 如果是基于 Model 的，可以使用 xadmin 提供的便利方法 </span>
<span class="sd">        :meth:`BaseAdminObject.get_model_perm` 和 :meth:`BaseAdminObject.get_model_url`。举例说明创建菜单::</span>

<span class="sd">            class AdminSettings(object):</span>

<span class="sd">                def get_site_menu(self):</span>
<span class="sd">                    return (</span>
<span class="sd">                        {&#39;title&#39;: &#39;内容管理&#39;, &#39;perm&#39;: self.get_model_perm(Article, &#39;change&#39;), &#39;menus&#39;:(</span>
<span class="sd">                            {&#39;title&#39;: &#39;游戏资料&#39;, &#39;icon&#39;: &#39;info-sign&#39;, &#39;url&#39;: self.get_model_url(Article, &#39;changelist&#39;) + &#39;?_rel_categories__id__exact=2&#39;},</span>
<span class="sd">                            {&#39;title&#39;: &#39;网站文章&#39;, &#39;icon&#39;: &#39;file&#39;, &#39;url&#39;: self.get_model_url(Article, &#39;changelist&#39;) + &#39;?_rel_categories__id__exact=1&#39;},</span>
<span class="sd">                        )},</span>
<span class="sd">                        {&#39;title&#39;: &#39;分类管理&#39;, &#39;perm&#39;: self.get_model_perm(Category, &#39;change&#39;), &#39;menus&#39;:(</span>
<span class="sd">                            {&#39;title&#39;: &#39;主要分类&#39;, &#39;url&#39;: self.get_model_url(Category, &#39;changelist&#39;) + &#39;?_p_parent__isnull=True&#39;},</span>
<span class="sd">                            {&#39;title&#39;: &#39;游戏资料&#39;, &#39;url&#39;: self.get_model_url(Category, &#39;changelist&#39;) + &#39;?_rel_parent__id__exact=2&#39;},</span>
<span class="sd">                        )},</span>
<span class="sd">                    )</span>

<span class="sd">            site.register(CommAdminView, AdminSettings)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_nav_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回网站菜单，如果 :meth:`get_site_menu` 返回的结果不是 None ，那么将把其返回结果作为菜单的第一部分，而后会补全没有出现的 Model 列表页菜单项，</span>
<span class="sd">        如果 :meth:`get_site_menu` 返回为 None， 那么将自动根据 App 和 Model 生成两级的菜单。</span>

<span class="sd">        :rtype: 格式见 :meth:`get_site_menu` 返回格式</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">site_menu</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_site_menu</span><span class="p">()</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">had_urls</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># 选出所有已经存在的菜单项的 URL，后期自动生成菜单时会排除这些项。</span>
        <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="n">had_urls</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
                <span class="n">had_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menu</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;menus&#39;</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">]:</span>
                    <span class="n">get_url</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">had_urls</span><span class="p">)</span>
        <span class="n">get_url</span><span class="p">({</span><span class="s">&#39;menus&#39;</span><span class="p">:</span> <span class="n">site_menu</span><span class="p">},</span> <span class="n">had_urls</span><span class="p">)</span>

        <span class="n">nav_menu</span> <span class="o">=</span> <span class="n">SortedDict</span><span class="p">()</span>    <span class="c">#使用有序 dict，保证每次生成的菜单顺序固定</span>

        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_admin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_admin</span><span class="p">,</span> <span class="s">&#39;hidden_menu&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">app_label</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
            <span class="n">app_icon</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">model_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">capfirst</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name_plural</span><span class="p">)),</span>
                <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_url</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;changelist&quot;</span><span class="p">),</span>
                <span class="s">&#39;icon&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_icon</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
                <span class="s">&#39;perm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_perm</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&#39;view&#39;</span><span class="p">),</span>
                <span class="s">&#39;order&#39;</span><span class="p">:</span> <span class="n">model_admin</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">model_dict</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">had_urls</span><span class="p">:</span>
                <span class="c"># 过如该url已经在之前的菜单项中存在，就跳过该项</span>
                <span class="k">continue</span>

            <span class="n">app_key</span> <span class="o">=</span> <span class="s">&quot;app:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">app_label</span>
            <span class="k">if</span> <span class="n">app_key</span> <span class="ow">in</span> <span class="n">nav_menu</span><span class="p">:</span>
                <span class="n">nav_menu</span><span class="p">[</span><span class="n">app_key</span><span class="p">][</span><span class="s">&#39;menus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Find app title</span>
                <span class="n">app_title</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">app_label</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">app_label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_label_title</span><span class="p">:</span>
                    <span class="n">app_title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_label_title</span><span class="p">[</span><span class="n">app_label</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mods</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mods</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s">&#39;verbose_name&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
                                <span class="n">app_title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s">&#39;verbose_name&#39;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="s">&#39;app_title&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
                                <span class="n">app_title</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s">&#39;app_title&#39;</span><span class="p">)</span>
                <span class="c">#find app icon</span>
                <span class="k">if</span> <span class="n">app_label</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_icons</span><span class="p">:</span>
                    <span class="n">app_icon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps_icons</span><span class="p">[</span><span class="n">app_label</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

                <span class="n">nav_menu</span><span class="p">[</span><span class="n">app_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">app_title</span><span class="p">,</span>
                    <span class="s">&#39;menus&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">model_dict</span><span class="p">],</span>
                <span class="p">}</span>

            <span class="n">app_menu</span> <span class="o">=</span> <span class="n">nav_menu</span><span class="p">[</span><span class="n">app_key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">app_icon</span><span class="p">:</span>
                <span class="n">app_menu</span><span class="p">[</span><span class="s">&#39;first_icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app_icon</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s">&#39;first_icon&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">app_menu</span> <span class="ow">or</span>
                    <span class="n">app_menu</span><span class="p">[</span><span class="s">&#39;first_icon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_icon</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;icon&#39;</span><span class="p">):</span>
                <span class="n">app_menu</span><span class="p">[</span><span class="s">&#39;first_icon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s">&#39;icon&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="s">&#39;first_url&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">app_menu</span> <span class="ow">and</span> <span class="n">model_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">):</span>
                <span class="n">app_menu</span><span class="p">[</span><span class="s">&#39;first_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_dict</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="n">nav_menu</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">menu</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sortkeypicker</span><span class="p">([</span><span class="s">&#39;order&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">]))</span>

        <span class="n">nav_menu</span> <span class="o">=</span> <span class="n">nav_menu</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">nav_menu</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">])</span>

        <span class="n">site_menu</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nav_menu</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">site_menu</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Context Params** :</span>

<span class="sd">            ``site_title`` : 使用 :attr:`site_title` 属性，默认为 &quot;Django Xadmin&quot;</span>

<span class="sd">            ``nav_menu`` : 权限过滤后的系统菜单项，如果在非 DEBUG 模式，该项会缓存在 SESSION 中</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CommAdminView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>

        <span class="c"># DEBUG模式会首先尝试从SESSION中取得缓存的菜单项</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="ow">and</span> <span class="s">&#39;nav_menu&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">:</span>
            <span class="n">nav_menu</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;nav_menu&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">menus</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_nav_menu</span><span class="p">())</span>

            <span class="k">def</span> <span class="nf">check_menu_permission</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">need_perm</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;perm&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">need_perm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">need_perm</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">need_perm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">need_perm</span> <span class="o">==</span> <span class="s">&#39;super&#39;</span><span class="p">:</span>    <span class="c"># perm项如果为 ``super`` 说明需要超级用户权限</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">need_perm</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">filter_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="k">if</span> <span class="s">&#39;menus&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">before_filter_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">])</span>
                    <span class="n">item</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_item</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">check_menu_permission</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
                    <span class="n">after_filter_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">after_filter_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">before_filter_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span>
                <span class="k">return</span> <span class="n">item</span>

            <span class="n">nav_menu</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">menus</span> <span class="k">if</span> <span class="n">check_menu_permission</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span>
            <span class="n">nav_menu</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">,</span> <span class="n">nav_menu</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;nav_menu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">nav_menu</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">def</span> <span class="nf">check_selected</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="c"># 判断菜单项是否被选择，使用当前url跟菜单项url对比</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="s">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
                <span class="n">chop_index</span> <span class="o">=</span> <span class="n">menu</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chop_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">menu</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">menu</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">][:</span><span class="n">chop_index</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;menus&#39;</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">[</span><span class="s">&#39;menus&#39;</span><span class="p">]:</span>
                    <span class="n">_s</span> <span class="o">=</span> <span class="n">check_selected</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_s</span><span class="p">:</span>
                        <span class="n">selected</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">selected</span><span class="p">:</span>
                <span class="n">menu</span><span class="p">[</span><span class="s">&#39;selected&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="n">selected</span>
        <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="n">nav_menu</span><span class="p">:</span>
            <span class="n">check_selected</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;menu_template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">menu_template</span><span class="p">,</span>
            <span class="s">&#39;nav_menu&#39;</span><span class="p">:</span> <span class="n">nav_menu</span><span class="p">,</span>
            <span class="s">&#39;site_title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_title</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s">u&#39;Django Xadmin&#39;</span><span class="p">),</span>
            <span class="s">&#39;site_footer&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_footer</span> <span class="ow">or</span> <span class="n">_</span><span class="p">(</span><span class="s">u&#39;my-company.inc 2013&#39;</span><span class="p">),</span>
            <span class="s">&#39;breadcrumbs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_breadcrumb</span><span class="p">()</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="n">context</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_model_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        取得 Model 图标，Model 图标会作为 css class，一般生成 HTML 如下::</span>

<span class="sd">            &lt;i class=&quot;icon-model icon-{{model_icon}}&quot;&gt;&lt;/i&gt;</span>

<span class="sd">        这是 Bootstrap 标准的图标格式，xadmin 目前是用了 Font Icon (Font-Awesome)，您可以制作自己的图标，具体信息可以参考</span>
<span class="sd">        `如何制作自己的字体图标 &lt;http://fortawesome.github.com/Font-Awesome/#contribute&gt;`_</span>

<span class="sd">        .. note::</span>

<span class="sd">            Model 图标，目前被使用在以下几个地方，当然您也可以随时使用在自己实现的页面中:</span>

<span class="sd">                * 系统菜单</span>
<span class="sd">                * 列表页面标题中</span>
<span class="sd">                * 添加、修改及删除页面的标题中</span>

<span class="sd">        ``FAQ: 如果定义 Model 图标``</span>

<span class="sd">        您可以在 :class:`CommAdminView` 的 OptionClass 中通过 :attr:`CommAdminView.globe_models_icon` 属性设定全局的 Model 图标。</span>
<span class="sd">        或者在 Model 的 OptionClass 中设置 :attr:`model_icon` 属性。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># 首先从全局图标中获取</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_models_icon</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">icon</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">_registry</span><span class="p">:</span>
            <span class="c"># 如果 Model 的 OptionClass 中有 model_icon 属性，则使用该属性</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">model</span><span class="p">],</span>
                           <span class="s">&#39;model_icon&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model_icon</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">icon</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_breadcrumb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_admin_url</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Home&#39;</span><span class="p">)</span>
            <span class="p">}]</span>

<span class="k">class</span> <span class="nc">ModelAdminView</span><span class="p">(</span><span class="n">CommAdminView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    基于 Model 的 AdminView，该类的子类，在 AdminSite 生成 urls 时，会为每一个注册的 Model 生成一个 url 映射。</span>
<span class="sd">    ModelAdminView 注册时使用 :meth:`xadmin.sites.AdminSite.register_modelview` 方法注册，具体使用实例可以参见该方法的说明，或参考实例::</span>

<span class="sd">        from xadmin.views import ModelAdminView</span>

<span class="sd">        class TestModelAdminView(ModelAdminView):</span>
<span class="sd">            </span>
<span class="sd">            def get(self, request, obj_id):</span>
<span class="sd">                pass</span>

<span class="sd">        site.register_modelview(r&#39;^(.+)/test/$&#39;, TestModelAdminView, name=&#39;%s_%s_test&#39;)</span>

<span class="sd">    注册后，用户可以通过访问 ``/%(app_label)s/%(module_name)s/123/test`` 访问到该view</span>

<span class="sd">    **Option 属性**</span>

<span class="sd">        .. autoattribute:: fields</span>
<span class="sd">        .. autoattribute:: exclude</span>
<span class="sd">        .. autoattribute:: ordering</span>
<span class="sd">        .. autoattribute:: model</span>

<span class="sd">    **实例属性**</span>

<span class="sd">        .. py:attribute:: opts</span>

<span class="sd">            即 Model._meta</span>

<span class="sd">        .. py:attribute:: app_label</span>

<span class="sd">            即 Model._meta.app_label</span>

<span class="sd">        .. py:attribute:: module_name</span>

<span class="sd">            即 Model._meta.module_name</span>

<span class="sd">        .. py:attribute:: model_info</span>

<span class="sd">            即 (self.app_label, self.module_name)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="bp">None</span>    <span class="c">#: (list,tuple) 默认显示的字段</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c">#: (list,tuple) 排除的字段，主要用在编辑页面</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c">#: (dict) 获取 Model 的 queryset 时默认的排序规则</span>
    <span class="n">model</span> <span class="o">=</span> <span class="bp">None</span>     <span class="c">#: 绑定的 Model 类，在注册 Model 时，该项会自动附在 OptionClass 中，见方法 :meth:`AdminSite.register`</span>
    <span class="n">remove_permissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c">#: 即 Model._meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="c">#: 即 Model._meta.app_label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
        <span class="c">#: 即 Model._meta.module_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">module_name</span>
        <span class="c">#: 即 (self.app_label, self.module_name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ModelAdminView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Context Params** :</span>

<span class="sd">            ``opts`` : Model 的 _meta</span>

<span class="sd">            ``app_label`` : Model 的 app_label</span>

<span class="sd">            ``module_name`` : Model 的 module_name</span>

<span class="sd">            ``verbose_name`` : Model 的 verbose_name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;opts&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">,</span>
            <span class="s">&quot;app_label&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
            <span class="s">&quot;module_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span>
            <span class="s">&quot;verbose_name&quot;</span><span class="p">:</span> <span class="n">force_unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">),</span>
            <span class="s">&#39;model_icon&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model_icon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelAdminView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_breadcrumb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bcs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ModelAdminView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_breadcrumb</span><span class="p">()</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">verbose_name_plural</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_view_permission</span><span class="p">():</span>
            <span class="n">item</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_admin_url</span><span class="p">(</span><span class="s">&#39;changelist&#39;</span><span class="p">)</span>
        <span class="n">bcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bcs</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        根据 object_id 获得唯一的 Model 实例，如果 pk 为 object_id 的 Model 不存在，则返回 None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">model</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">object_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">object_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">object_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@filter_hook</span>
    <span class="k">def</span> <span class="nf">get_object_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_change_permission</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_admin_url</span><span class="p">(</span><span class="s">&quot;change&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">attname</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_view_permission</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_admin_url</span><span class="p">(</span><span class="s">&quot;detail&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">attname</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">model_admin_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        等同于 :meth:`BaseAdminObject.get_admin_url` ，只是无需填写 model 参数， 使用本身的 :attr:`ModelAdminView.model` 属性。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_name</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回包含 Model 所有权限的 dict。dict 的 key 值为： ``add`` ``view`` ``change`` ``delete`` ， </span>
<span class="sd">        value 为 boolean 值，表示当前用户是否具有相应的权限。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;view&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_view_permission</span><span class="p">(),</span>
            <span class="s">&#39;add&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_add_permission</span><span class="p">(),</span>
            <span class="s">&#39;change&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_change_permission</span><span class="p">(),</span>
            <span class="s">&#39;delete&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_delete_permission</span><span class="p">(),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_template_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        根据 template_name 返回一个 templates 列表，生成页面是在这些列表中寻找存在的模板。这样，您就能方便的复写某些模板。列表的格式为::</span>

<span class="sd">            &quot;xadmin/%s/%s/%s&quot; % (opts.app_label, opts.object_name.lower(), template_name),</span>
<span class="sd">            &quot;xadmin/%s/%s&quot; % (opts.app_label, template_name),</span>
<span class="sd">            &quot;xadmin/%s&quot; % template_name,</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s">&quot;xadmin/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">object_name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">template_name</span><span class="p">),</span>
            <span class="s">&quot;xadmin/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">template_name</span><span class="p">),</span>
            <span class="s">&quot;xadmin/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">template_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回 Model 列表的 ordering， 默认就是返回 :attr:`ModelAdminView.ordering` ，子类可以复写该方法</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ordering</span> <span class="ow">or</span> <span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回 Model 的 queryset。可以使用该属性查询 Model 数据。</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_default_manager</span><span class="o">.</span><span class="n">get_query_set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">has_view_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回当前用户是否有查看权限</span>

<span class="sd">        .. note::</span>

<span class="sd">            目前的实现为：如果一个用户有对数据的修改权限，那么他就有对数据的查看权限。当然您可以在子类中修改这一规则</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;view&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_permissions</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.view_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span><span class="p">)</span> <span class="ow">or</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.change_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">has_add_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回当前用户是否有添加权限</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;add&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_permissions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.add_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_change_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回当前用户是否有修改权限</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;change&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_permissions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.change_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_delete_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        返回当前用户是否有删除权限</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;delete&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_permissions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.delete_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_info</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Django Xadmin 2.1.5 beta documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../views.html" >xadmin.views</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, sshwsfc.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>